#pragma once

#include "DifferentialGeometry.h"
#include "Primitive.h"
#include "Geometry.h"
#include "Ray.h"

///////////////////////////////////////////////////////////////////////////////
/// \brief Data structure that stores intersection informations.
///////////////////////////////////////////////////////////////////////////////
class Intersection
{
public:
	///////////////////////////////////////////////////////////////////////////
	/// \brief Default constructor.
	///////////////////////////////////////////////////////////////////////////
	Intersection();

	///////////////////////////////////////////////////////////////////////////
	/// \brief Destructor.
	///////////////////////////////////////////////////////////////////////////
	~Intersection();

	///////////////////////////////////////////////////////////////////////////
	/// \brief Transforms the given vector in a local coordinates vector.
	///////////////////////////////////////////////////////////////////////////
	Vector3d toLocal(const Vector3d& v)
	{
		return myShadingGeometry.toLocal(v);
	}

	///////////////////////////////////////////////////////////////////////////
	/// \brief Transforms the given local vector in a world coordinates vector.
	///////////////////////////////////////////////////////////////////////////
	Vector3d toWorld(const Vector3d& v)
	{
		return myShadingGeometry.toWorld(v);
	}

	///////////////////////////////////////////////////////////////////////////
	/// \brief 
	///////////////////////////////////////////////////////////////////////////
	bool isMediumTransition()
	{
		return myPrimitive->getInteriorMedium() != myPrimitive->getExteriorMedium();
	}

	///////////////////////////////////////////////////////////////////////////
	/// \brief Returns the appropriate medium
	///////////////////////////////////////////////////////////////////////////
	Medium::ptr getMedium(const Ray& r)
	{
		if (myShadingGeometry.myN.dot(r.direction()) < 0.)
			return myPrimitive->getInteriorMedium();

		return myPrimitive->getExteriorMedium();
	}

	///Parametric intersection distance
	real t;
	///True differential geometry (for ex. face normal and not interpolated
	///normal at the intersection point)
	DifferentialGeometry myTrueGeometry;
	///Geometry at the intersection point
	DifferentialGeometry myShadingGeometry;
	///intersected Primitive
	IPrimitive::ptr myPrimitive;
	///UV coordinates
	Point2d myUv;
	///Intersection point
	Point3d myPoint;

	Ray myRay;

	bool computeIntersect;
};

